#!/bin/sh
# This script initializes Regolith and launches i3.

# File Locations - Optional User Overrides
USER_XRESOURCE_FILE="$HOME/.Xresources-regolith"
USER_I3_CONFIG_FILE="$HOME/.config/regolith/i3/config"

# File Locations - System Defaults
DEFAULT_XRESOURCE_FILE="/etc/regolith/styles/root"
DEFAULT_I3_CONFIG_FILE="/etc/regolith/i3/config"
BASELINE_I3_CONFIG_FILE="/etc/i3/config"

# Register with gnome-session so that it does not kill the whole session thinking it is dead.
if [ -n "$DESKTOP_AUTOSTART_ID" ]; then
	dbus-send --print-reply --session --dest=org.gnome.SessionManager "/org/gnome/SessionManager" org.gnome.SessionManager.RegisterClient "string:i3-gnome" "string:$DESKTOP_AUTOSTART_ID"
fi

# Load Xresources
if [ -f "$USER_XRESOURCE_FILE" ]; then
        xrdb -merge $USER_XRESOURCE_FILE
else
        xrdb -merge $DEFAULT_XRESOURCE_FILE
fi

# Determine i3 config file
if [ -f "$USER_I3_CONFIG_FILE" ]; then
        REGOLITH_I3_CONFIG_FILE=$USER_I3_CONFIG_FILE
elif [ -f "$DEFAULT_I3_CONFIG_FILE" ]; then
        REGOLITH_I3_CONFIG_FILE=$DEFAULT_I3_CONFIG_FILE
else 
        REGOLITH_I3_CONFIG_FILE=$BASELINE_I3_CONFIG_FILE
fi

# The following stanza is to set Regolith-specific changes over default Ubuntu settings.
UPDATE_FLAG_DIR="$HOME/.config/regolith/flags"
UPDATE_FLAG_FILE="$UPDATE_FLAG_DIR/first-time-setup"
if [ ! -f "$UPDATE_FLAG_FILE" ]; then
        echo "Executing Regolith session configuration script."

        # Required for i3 and gnome-shell to coexist
        gsettings set org.gnome.desktop.background show-desktop-icons false
        gsettings set org.gnome.gnome-flashback desktop-background true

        # Remap default keyboard switch keybindings to avoid collision w/ i3
        gsettings set org.gnome.desktop.wm.keybindings switch-input-source "['<Alt><Super>BackSpace']"
        gsettings set org.gnome.desktop.wm.keybindings switch-input-source-backward "['<Shift><Alt><Super>BackSpace']"

        # Set the wallpaper
        gsettings set org.gnome.desktop.background picture-uri "file:///usr/share/backgrounds/ESP_020528_1750_desktop.jpg"

        # Only run this script once per install of Regolith.
        mkdir -p $UPDATE_FLAG_DIR
        touch $UPDATE_FLAG_FILE
fi

# Set the theme
gsettings set org.gnome.desktop.interface gtk-theme "`xrescat gnome.gtk.theme SolArc-Dark`"
gsettings set org.gnome.desktop.wm.preferences theme "`xrescat gnome.wm.theme SolArc-Dark`"
gsettings set org.gnome.desktop.interface icon-theme "`xrescat gnome.icon.theme Arc`"

# Launch i3wm with the Regolith configuration
echo "Launching i3-gaps with $REGOLITH_I3_CONFIG_FILE"
i3 -c $REGOLITH_I3_CONFIG_FILE

# Close session when i3 exits.
if [ -n "$DESKTOP_AUTOSTART_ID" ]; then
	dbus-send --print-reply --session --dest=org.gnome.SessionManager "/org/gnome/SessionManager" org.gnome.SessionManager.Logout "uint32:1"
fi
